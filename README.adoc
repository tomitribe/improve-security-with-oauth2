:encoding: UTF-8
:linkattrs:
:sectlink:
:sectanchors:
:sectid:
:imagesdir: media
:leveloffset: 1

= Secure Microservices with OAuth 2.0 and JWT
Time: 10 minutes

== Learning objectives

* OAuth 2.0
* JSON Web Tokens (JWT)
* How to secure a microservice with the Tribestream API Gateway (TAG)
* Authorization using roles

== Prerequisites

* Docker installed and running.
* Curl installed.


== Run Docker Containers

Before digging into OAuth2 using TAG you need start the docker images of ElasticSearch and Kibana, TAG and the Movie-Api app.

=== Start the Movies Microservice

If you went through the _Tribestream Quickstart Guide_ you can reuse the _movie-api_ docker container. To start the movie-api execute the following command:
```
docker start movie-api
```

However, if this is the first time you hear about the `movie-api`, open the terminal and execute the following command.


```
docker run -d -p 9090:9090 --name movie-api  tomitribedev/movie-api
```

You can validate that the microservice is up and running by executing the command below:

```
curl -i http://localhost:9090/movie-api/api/movies
```

You should be able to see the movie-api microservice output:
```
HTTP/1.1 200 OK
X-Powered-By: Express
Content-Type: application/json; charset=utf-8
Content-Length: 907
ETag: W/"38b-nH1wH3YovzhC6d7xYfLwUga8Hf8"
Date: Wed, 04 Jul 2018 11:16:42 GMT
Connection: keep-alive

[{"comments":[],"year":2008,"director":"Sylvester Stallone","genrer":"Action","rating":7,"id":2,"title":"John Rambo"},{"comments":[],"year":2008,"director":"Sylvester Stallone","genrer":"Action","rating":7,"id":52,"title":"John
Rambo"},{"comments":[],"year":1999,"director":"Syl","genrer":"Sci-Fi","rating":9,"id":1,"title":"The Matrix"},{"comments":[],"year":1999,"director":"Syl","genrer":"Sci-Fi","rating":9,"id":51,"title":"The Matrix"},{"comments":[],"year":1997,"director":"Paul Verhoeven","genrer":"Sci-Fi","rating":7,"id":3,"title":"Starship Troopers"},{"comments":[],"year":1997,"director":"Paul Verhoeven","genrer":"Sci-Fi","rating":7,"id":53,"title":"Starship Troopers"},{"comments":[],"year":1994,"director":"Roland Emmerich","genrer":"Sci-Fi","rating":7,"id":4,"title":"Stargate"},{"comments":[],"year":1994,"director":"Roland Emmerich","genrer":"Sci-Fi","rating":7,"id":54,"title":"Stargate"}]%
```

=== Run the Tribestream API Gateway (TAG)

If you went through the _Tribestream Quickstart Guide_ you can reuse the _TAG_ docker container. To start TAG execute the following command:

```
docker start tag
```

However, if this is the first time you run TAG, open the terminal and execute the following command.

For linux:
```
docker run --net="host" -e LICENSE=accept --name tag -p 8080:8080 tomitribe/tribestream-api-gateway
```

For OSX:
```
docker run -e LICENSE=accept --name tag -p 8080:8080  tomitribe/tribestream-api-gateway`
```

TAG is ready when you see the following message in the logs:
```
INFO [main] org.apache.coyote.AbstractProtocol.start Starting ProtocolHandler ["http-bio-8080"]
INFO [main] org.apache.coyote.AbstractProtocol.start Starting ProtocolHandler ["ajp-bio-8009"]
INFO [main] org.apache.catalina.startup.Catalina.start Server startup in 18348 ms
```

== What is OAuth 2.0
OAuth2 is an open standard for authorization that enables client applications to access server resources on behalf of a specific Resource Owner which also enables the owner to authorize limited third-party access to their server resources without sharing their credentials.

The Tribestream API Gateway will help you to easily configure OAuth2 to protect your microservices. TAG issues tokens for the client applications on behalf of a Resource Owner, these tokens added to the request can be used to access the protected microservices.

== What is JSON Web Token (JWT)
JSON Web Token is an open standard that defines a compact and self-contained way for securely transmitting information between parties as a JSON object. This information can be verified and trusted because it is digitally signed.

TAG emits the access tokens using the JWT format. The emitted tokens will have all the claims with the necessary information like roles, groups, expiration date and others, thus TAG can authorize or deny access to a microservice.

== How to secure a microservice with the Tribestream API Gateway (TAG)

Let's imagine you as a TAG Administrator have to give access to a Movie Streaming Website, and this website will consume a movies microservice to therefore get the catalog of movies.

First step is to open the browser and navigate to link:http://localhost:8080/tag[,window="_blank"].

Login into the TAG dashboard using username: _admin_, password: _admin_.

image::login.gif[""]

=== Create a Client Account

Create the client account the Streaming Website is going to use, following the steps below:

* Click on the _Accounts_
* Click the _Plus button_ (+)
* Select _Account_

Fill the Account information with the following data:

* *Username*: _streaming-website_
* *Email*: _streaming-website@email.com_
* *Full Name*: _Streaming Website_

image::create-client-account.png[""]

After clicking _Save_ you will be redirected to a page with all the _streaming-website_ account information.

Add a Client Secret with the following steps: +

* Click the _…_
* Select _Add Client Secret_ on the menu

Use the following data in the _Add Client Secret_ window: +

* *New Client Secret*: _12345678_
* *Re-type*: _12345678_
* *OAuth Security Profile*: _OAuth2 Profile_
* Click _Save_

image::add-client-secret.png[""]

You also need to create a user for the Streaming Website owner.

* Go back to the _Accounts_
* Click the _Plus button_ (+)
* Select _Account_

Fill the Account information with the following data:

* *Username*: _Alice_
* *Email*: _alice@email.com_
* *Full Name*: _Alice_
* *Roles*: _Streaming-App-Owner_

You will be redirected to the Account page with Alice's information.

* Click _..._
* Select Add password
* Type password _abcde123_
* Click _Save_

=== Create a Route with the OAuth2 Security Profile

Now let's create a secured OAuth2 route to the Microservice Movies a give access only to users that have the _Streaming-App-Owner_ role.

On the Dashboard page execute the following steps:

* Click on the _Routes_
* Click the _Plus button_(+)
* Select _MOD_REWRITE ROUTE_

Then fill the form with the following data:

* Add the MOD_REWRITE description below
```
RewriteRule "^/streaming-movies$" "http://localhost:9090/movie-api/api/movies" [P,NE,auth]
```

PS: If you are using OSX as the operating system, replace _localhost_ for _host.docker.internal_.

* *Security Profiles*: _OAuth2 Profile_
* *Roles*: _Streaming-App-Owner_

image::create-route.png[""]

After clicking _Save_ you will be on the page of your created route. You now have a route _/streaming-movies_ secured with OAuth2 and only calls from accounts with the role _Streaming-App-Owner_ will be proxied to the movies microservice.

== Calling the Streaming Movies Route
You can test the behavior of the TAG configuration directly from the Route screen.

* Click _..._
* Click _Test_

This will open the _Test Routes_ screen, thus set the *Resource URL* to _/streaming-movies_.

image::test-window.png[""]

Add OAuth2 Authentication with the following steps:

* Click on `…` button
* Select `Add OAuth 2.0`
* Scroll down to the OAuth2 section
* Fill *Username* with _alice_
* Fill *Password* with _abcde123_
* Fill *Client Id* with _streaming-website_
* Fill *Client Secret* with _12345678_

image::test-window-with-oauth2.png[""]

After that click _Test_. If everything was set up correctly, you will get a _200 OK_ in the Response, which means you were able to get a token with the provided credentials, and use this token to call the /streaming-movies route successfully.

image::test-window-with-oauth2-200.png[""]

If you remove the _Streaming-App-Owner_ role from Alice, you will see that the route will deny the request because the user doesn't have the required role to access the route.

image::test-window-with-oauth2-403.png[""]

== Stop the Docker containers

After executing this tutorial stop all docker images so it does not overload your computer.
```
docker stop tag
docker stop movie-api
```
